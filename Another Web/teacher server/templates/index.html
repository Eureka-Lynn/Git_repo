<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>教师端实时监控</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>学生列表</h1>
    <ul id="student-list"></ul>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 学生数据存储，key是student_id
            const students = {};

            // 1. 先从后端API拉取已有学生信息
            try {
                const res = await fetch('/students');
                if (!res.ok) throw new Error('获取学生数据失败');
                const existingStudents = await res.json();
                existingStudents.forEach(s => {
                    students[s.student_id] = s;
                });
                updateList();
            } catch (err) {
                console.error('加载学生列表错误:', err);
            }

            // 2. 连接 Socket.IO 监听实时mqtt_message推送
            const socket = io();

            socket.on('connect', () => {
                console.log('成功连接到 Socket.IO 服务器');
            });

            socket.on('disconnect', () => {
                console.log('已断开与服务器连接');
            });

            socket.on('mqtt_message', msg => {
                // 只处理学生加入的消息示例
                if (msg.topic === 'classroom/students/join') {
                    const data = msg.data;
                    if (data.student_id) {
                        students[data.student_id] = data;
                        updateList();
                    }
                }
                // 你可以在这里处理其它topic，比如举手状态等
            });

            socket.on('connect_error', (err) => {
                console.error('连接错误:', err);
            });

            // 更新学生列表DOM
            function updateList() {
                const ul = document.getElementById('student-list');
                ul.innerHTML = ''; // 清空列表

                Object.values(students).forEach(stu => {
                    const li = document.createElement('li');
                    li.textContent = `${stu.name} (${stu.student_id})`;
                    ul.appendChild(li);
                });

                console.log('学生列表已更新，当前学生数:', Object.keys(students).length);
            }
        });
    </script>
</body>
</html>
