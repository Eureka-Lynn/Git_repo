<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>教师端实时监控</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>学生列表</h1>
    <ul id="student-list"></ul>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const students = {};

            async function fetchStudents() {
                const res = await fetch('/students');
                const data = await res.json();
                data.forEach(s => {
                    students[s.student_id] = s;
                });
                updateList();
            }

            function updateList() {
                const ul = document.getElementById('student-list');
                ul.innerHTML = '';
                Object.values(students).forEach(stu => {
                    const li = document.createElement('li');
                    li.textContent = `${stu.name} (${stu.student_id})`;
                    if (stu.hand_raised) {
                        const btn = document.createElement('button');
                        btn.textContent = '取消举手';
                        btn.onclick = async () => {
                            const resp = await fetch(`/cancel_hand_raise/${stu.student_id}`, {method: 'POST'});
                            if (resp.ok) {
                                stu.hand_raised = false;
                                updateList();
                            }
                        };
                        li.appendChild(btn);
                    }
                    ul.appendChild(li);
                });
            }

            await fetchStudents();

            const socket = io();
            socket.on('mqtt_message', msg => {
                if (msg.topic === 'classroom/students/join' || msg.topic === 'classroom/students/hand_raise') {
                    const sid = msg.data.student_id;
                    students[sid] = msg.data;
                    updateList();
                }
            });
        });
    </script>
</body>
</html>
